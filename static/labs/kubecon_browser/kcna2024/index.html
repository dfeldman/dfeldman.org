<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KubeCon Browser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.basic.min.js"></script>
    <script data-goatcounter="https://dfeldman.goatcounter.com/count" async src="/js/count.js"></script>

    <style>
        :root {
            --gradient-start: #4f46e5;
            --gradient-end: #2563eb;
            --panel-bg: #ffffff;
            --border-color: #e5e7eb;
            --search-bg: #ddfaff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.5;
            color: #1a1a1a;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-rows: 1fr 6px 1fr;
            padding: 1rem;
            position: relative;
            min-width: 0;
        }

        .gutter {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            width: 6px;
            cursor: col-resize;
            position: relative;
        }

        .gutter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .horizontal-gutter {
            background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
            height: 6px;
            cursor: row-resize;
            grid-column: 1 / -1;
        }

        .resize-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 1000;
        }

        .resize-overlay.horizontal {
            cursor: row-resize;
        }

        .resize-overlay.vertical {
            cursor: col-resize;
        }

        .slides-panel {
            background: var(--panel-bg);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            min-height: 0;
            display: flex;
        }

        .video-panel {
            position: relative;
            background: var(--panel-bg);
            border-radius: 1rem;
            overflow: hidden;
            min-height: 0;
            display: flex;
            flex: 1;
        }

        .iframe-container {
            position: relative;
            width: 100%;
            /* Take full width */
            height: 100%;
            /* Take full height */
            display: flex;
        }

        .iframe-container iframe {
            position: absolute;
            width: 100%;
            height: 100%;
            border: none;
        }


        .table-panel {
            background: var(--panel-bg);
            width: 400px;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            margin: 1rem 1rem 1rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .search-container {
            padding: 1rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 1rem 1rem 0 0;
        }

        .search-bar {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            background: white;
            color: #1a1a1a;
        }

        .search-bar:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }

        .presentations-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .presentation-item {
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .presentation-item.active {
            background: var(--search-bg);
        }


        .presentation-header {
            padding: 1rem;
            padding-bottom: 0.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .presentation-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .presentation-speakers {
            color: #666;
            font-size: 0.9rem;
        }

        .presentation-content {
            padding: 1rem;
            padding-top: 0;
            display: block;
        }

        .presentation-item {
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 1rem;
        }

        .presentation-item.active {
            background: var(--search-bg);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            margin: 0.5rem 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Optional: Add some hover effect for non-active items */
        .presentation-item:not(.active):hover {
            background: #eeeeee;
        }
        /* .presentation-header .arrow {
            transition: transform 0.3s ease;
        }

        .presentation-header .arrow.active {
            transform: rotate(180deg);
        } */

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 1rem;
        }

        .tag {
            cursor: pointer;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }


        .tag:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }

        .toggle-sidebar {
            display: none;
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: none;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }


        .iframe-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f9fafb;
            color: #666;
            text-align: center;
            padding: 1rem;
        }

        .slides-panel {
            background: var(--panel-bg);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            min-height: 0;
            display: flex;
            transition: all 0.3s ease;
        }

        .horizontal-gutter {
            background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
            height: 6px;
            cursor: row-resize;
            grid-column: 1 / -1;
            transition: all 0.3s ease;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-rows: 1fr 6px 1fr;
            padding: 1rem;
            position: relative;
            min-width: 0;
            transition: grid-template-rows 0.3s ease;
        }

        .no-results {
            padding: 2rem;
            text-align: center;
            color: #666;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin: 1rem;
        }

        .source-link {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .source-link a {
            color: var(--gradient-start);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .source-link a:hover {
            text-decoration: underline;
        }


        /* Tab styling */
        .content-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--panel-bg);
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background: #f3f4f6;
        }

        .tab-button.active {
            color: var(--gradient-start);
            background: #f0f7ff;
            font-weight: 500;
        }

        /* Update these CSS rules */
        /* Ensure full height flows through the container hierarchy */
        .container {
            height: 100vh;
            display: flex;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Allow flex children to shrink */
        }

        .bottom-panel {
            flex: 1;
            /* Take remaining space */
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Allow children to shrink */
        }

        .tab-content {
            flex: 1;
            /* Take remaining space */
            display: flex;
            min-height: 0;
            /* Critical for nested flex items */
        }

        .tab-panel {
            flex: 1;
            /* Take full space of parent */
            display: none;
            min-height: 0;
            /* Allow content to shrink */
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        #video-tab {
            flex: 1;
            display: none;
            min-height: 0;
        }

        #video-tab.active {
            display: flex;
            flex-direction: column;
        }

        .video-container {
            flex: 1;
            /* Take remaining space */
            position: relative;
        }

        .tab-panel.active {
            display: flex;
            /* Show when active */
            flex: 1;
        }

        /* new try  */
        #slides-tab.active {
            display: flex;
            /* Override any inherited display */
            width: 100%;
            min-width: 0;
            /* Allow flex shrinking */
        }

        .slides-browser {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        .slides-viewer {
            display: flex;
            flex-direction: column;
            flex: 1;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        .current-slide {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
            margin-bottom: 1rem;
            overflow: hidden;
        }



        .video-panel {
            min-height: 0;
            /* Allow shrinking */
            flex: 1;
            /* Take available space */
        }

        .mobile-only {
            display: none !important;
        }


        /* Mobile specific styles */
        @media (max-width: 1000px) {
            .desktop-only {
                display: none !important;
            }

            .horizontal-gutter {
                display: none;
            }

            .mobile-only {
                display: block !important;
            }

            .tab-button.mobile-only {
                display: inline-block !important;
            }

            /* Hide main video panel on mobile when using tabs */
            .main-content>.video-panel {
                display: none !important;
            }

            /* Style the video tab */
            #video-tab .video-container {
                position: relative;
                padding-bottom: 56.25%;
                /* 16:9 aspect ratio */
                height: 0;
                overflow: hidden;
            }

            #video-tab .iframe-container {
                /* position: absolute;
        top: 5rem; // This is a hack to  */
                left: 0;
                width: 100%;
                height: 80%;
            }

            .container {
                flex-direction: column;
            }

            .main-content {
                height: 100vh;
                padding-bottom: 1rem;
            }

            .table-panel {
                position: fixed;
                right: -400px;
                top: 0;
                bottom: 0;
                margin: 0;
                transition: right 0.3s ease;
                z-index: 100;
            }

            .table-panel.active {
                right: 0;
            }

            .toggle-sidebar {
                display: block;
            }

            .gutter {
                display: none;
            }
        }

        /* Mobile specific styles - LANDSCAPE */
        @media (max-height: 768px) {
            .desktop-only {
                display: none !important;
            }

            .horizontal-gutter {
                display: none;
            }

            .mobile-only {
                display: block !important;
            }

            .tab-button.mobile-only {
                display: inline-block !important;
            }

            /* Hide main video panel on mobile when using tabs */
            .main-content>.video-panel {
                display: none !important;
            }

            /* Style the video tab */
            #video-tab .video-container {
                position: relative;
                padding-bottom: 56.25%;
                /* 16:9 aspect ratio */
                height: 0;
                overflow: hidden;
            }

            #video-tab .iframe-container {
                /* position: absolute;
        top: 5rem; // This is a hack to  */
                left: 0;
                width: 100%;
                height: 80%;
            }

            .container {
                flex-direction: column;
            }

            .main-content {
                height: 100vh;
                padding-bottom: 1rem;
            }

            .table-panel {
                position: fixed;
                right: -400px;
                top: 0;
                bottom: 0;
                margin: 0;
                transition: right 0.3s ease;
                z-index: 100;
            }

            .table-panel.active {
                right: 0;
            }

            .toggle-sidebar {
                display: block;
            }

            .gutter {
                display: none;
            }
        }


        /* This feature doesn't just need a desktop, it needs a BIG desktop */
        @media(max-width: 1400px) {
            .slides-thumbnails-wrapper {
                display: none;
            }
        }

        /* Styles for the Slide Browser screen */


        .slides-download-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            margin: auto;
        }

        .slides-download-button a {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s;
        }

        .slides-download-button a:hover {
            transform: scale(1.05);
        }


        .current-slide {
            height: calc(75%);
            /* Full height minus thumbnail height + gaps */
            width: 100%;
            background: #f8fafc;
            border-radius: 0.5rem;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }


        .current-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            align-items: center;
        }

        .slide-nav-buttons {
            position: absolute;
            top: 0;
            bottom: 0;
            left: -3rem;
            /* Move buttons outside the slide */
            right: -3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }

        .slide-nav-button {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: background 0.2s;
            pointer-events: auto;
            z-index: 2;
        }

        /* Add some padding to the slides-viewer to make room for buttons */
        .slides-viewer {
            padding: 0 3rem;
            box-sizing: border-box;
        }

        .slides-thumbnails-wrapper {
            height: 50%;
            /* Fixed height */
            width: 100%;
        }

        .slides-thumbnails {
            height: 100%;
            display: block;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            overflow-x: auto;
            text-align: center;
            ;
        }


        /* Make thumbnails fixed size to prevent layout jumping */
        .slide-thumbnail {
            /*flex: 0 0 auto;  /* Don't allow thumbnails to grow or shrink */
            display: inline;
            height: 120px;
            /* Fixed height */
            width: auto;
            /* Maintain aspect ratio */
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .slide-thumbnail.active {
            border-color: var(--gradient-start);
        }

        .slide-thumbnail img {
            height: auto;
            width: 20rem;
            display: inline;
        }

        /* Styles for the text tabs */

        .session-content,
        .outline-content,
        .transcript-content {
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin: 1rem;
            border: 1px solid var(--border-color);
            max-width: 70rem;
        }

        .transcript-content p {
            margin: 1rem 0;
        }

        /* Style the tab panel backgrounds */
        #session-tab,
        #outline-tab,
        #transcript-tab {
            background: #f3f4f6;
            /* Light grey background behind the "paper" */
            padding: 0.5rem;
            /* Add some space around the edges */
        }

        /* Make the warning stand out against the white background */
        .ai-warning {
            background: #fff3cd;
            color: #856404;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #ffeeba;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .session-content h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gradient-start);
        }

        .session-content .speakers {
            margin-bottom: 2rem;
        }

        .session-content .speaker {
            margin-bottom: 0.5rem;
        }

        .session-content .speaker-role {
            color: #666;
            font-size: 0.9rem;
        }

        .session-content .abstract {
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .session-content .links {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .session-content .link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gradient-start);
            text-decoration: none;
            margin-bottom: 0.5rem;
        }

        .session-content .link:hover {
            text-decoration: underline;
        }

        /* Add proper indentation for lists in text tabs */
        .session-content ul,
        .outline-content ul,
        .transcript-content ul {
            padding-left: 2rem;
            /* Space for bullets */
            margin: 1rem 0;
            /* Vertical spacing between lists and other elements */
        }

        .session-content li,
        .outline-content li,
        .transcript-content li {
            margin: 0.5rem 0;
            /* Spacing between list items */
        }

        /* Handle nested lists */
        .session-content ul ul,
        .outline-content ul ul,
        .transcript-content ul ul {
            margin: 0.5rem 0;
            /* Less margin for nested lists */
            padding-left: 1.5rem;
            /* Slightly less indentation for nested items */
        }


        .related-content {
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin: 1rem;
            border: 1px solid var(--border-color);
        }

        .related-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .related-item:hover {
            background: var(--search-bg);
        }

        .related-title {
            font-weight: 600;
            color: var(--gradient-start);
            margin-bottom: 0.5rem;
        }

        .related-speakers {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .related-match {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="resize-overlay" id="resizeOverlay"></div>







    <div class="container">
        <div class="table-panel">
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Search presentations...">
            </div>
            <div class="presentations-list" id="presentationsList">
                <!-- Presentations will be dynamically inserted here -->
            </div>
        </div>
        <div class="gutter" id="dragHandle"></div>

        <div class="main-content">
            <div class="video-panel">
                <div class="iframe-container">
                    <iframe src="/api/placeholder/400/320" allowfullscreen></iframe>
                </div>
            </div>
            <div class="horizontal-gutter"></div>
            <div class="bottom-panel"> <!-- Add this wrapper -->
                <div class="content-tabs">
                    <button class="tab-button mobile-only" data-tab="video">Video</button>
                    <button class="tab-button active" data-tab="session">Session</button>
                    <button class="tab-button" data-tab="slides">Slides</button>
                    <button class="tab-button outline-tab" data-tab="outline">Outline</button>
                    <button class="tab-button transcript-tab" data-tab="transcript">Notes</button>
                    <button class="tab-button" data-tab="related">Related</button>
                </div>
                <div class="tab-content">
                    <div id="video-tab" class="tab-panel">
                        <div class="iframe-container">
                            <iframe src="/api/placeholder/400/320" allowfullscreen></iframe>
                        </div>
                    </div>
                    <div id="session-tab" class="tab-panel active">
                        <div class="session-content"></div>
                    </div>
                    <div id="slides-tab" class="tab-panel">
                        <div class="slides-panel" id="slides-panel">
                        </div>
                    </div>
                    <div id="outline-tab" class="tab-panel">
                        <div class="outline-content"></div>
                    </div>
                    <div id="transcript-tab" class="tab-panel">
                        <div class="transcript-content"></div>
                    </div>
                    <div id="related-tab" class="tab-panel">
                        <div class="related-content"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <button class="toggle-sidebar" onclick="toggleSidebar()">â˜°</button>

    <script>
        let fuse;
        let fuseForRelated;
        let presentations = []; // Initialize empty array
        let aiData = [];
        let slidesData = [];
        const assetsBaseUrl = 'https://webassets.dfeldman.org/labs/kubecon_browser/kcna2024/';

        function isValidUrl(url) {
            return url && url.trim() !== '' && url !== 'about:blank';
        }

        // Be sure to update CSS if these change
        function isMobile() {
            return window.matchMedia('(max-width: 1000px)').matches || window.matchMedia('(max-height: 768px)').matches;
        }

        async function loadPresentations() {
            try {
                const [dataResponse, slidesResponse, aiResponse] = await Promise.all([
                    fetch('combined_data/data.json'),
                    fetch(assetsBaseUrl + 'slides.json'),
                    fetch(assetsBaseUrl + 'ai.json')
                ]);

                const [allPresentations, slidesData, aiData] = await Promise.all([
                    dataResponse.json(),
                    slidesResponse.json(),
                    aiResponse.json()
                ]);

                // TODO: If I put all the data in a single JSON, then I can pre-build the fuse.js index and cache it on the server.
                // This is difficult to do with 3 different files. It is only 6mb of text though...
                const allPresentationsMap = Object.fromEntries(allPresentations.map(p => [p.evtid, p]));
                const slidesMap = Object.fromEntries(slidesData.map(item => [item.evtid, item]));
                const aiMap = Object.fromEntries(aiData.map(item => [item.evtid, item]));

                // Check for orphaned supplementary data
                slidesData.forEach(item => {
                    if (!allPresentationsMap[item.evtid]) {
                        console.error(`Slides data exists for unknown event: ${item.evtid}`);
                    }
                });

                aiData.forEach(item => {
                    if (!allPresentationsMap[item.evtid]) {
                        console.error(`AI data exists for unknown event: ${item.evtid}`);
                    }
                });

                presentations = allPresentations
                    .map(presentation => {
                        // Log only missing data that should exist
                        if (presentation.slidesUrl && !slidesMap[presentation.evtid]) {
                            console.warn(`slidesUrl exists but no slides data for event: ${presentation.evtid}`);
                        }
                        if (presentation.videoUrl && !aiMap[presentation.evtid]) {
                            console.warn(`videoUrl exists but no AI data for event: ${presentation.evtid}`);
                        }

                        return {
                            ...presentation,
                            ...(slidesMap[presentation.evtid] || {}),
                            ...(aiMap[presentation.evtid] || {})

                        };
                    })
                    .filter(presentation => isValidUrl(presentation.videoUrl))
                    .sort((a, b) => a.title.localeCompare(b.title, undefined, { numeric: true, sensitivity: 'base' }));


                initializeSearch(presentations);
                initializeTabs();
                renderPresentations();

                const firstPresentation = document.querySelector('.presentation-header');
                if (firstPresentation) firstPresentation.click();

            } catch (error) {
                console.error('Error loading presentations:', error);
                document.getElementById('presentationsList').innerHTML =
                    '<div class="error-message">Error loading presentations. Please try again later.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPresentations();
            initializeResizing();
        });

        // function findRelatedPresentations(presentation, allPresentations, maxResults = 5) {
        //     // Create a temporary Fuse instance for this search


        //     // Use the presentation's tags and title as the search query
        //     const searchString = [
        //         ...(presentation.tags || []),
        //         ...(presentation.aitags || []),
        //        // ...(presentation.keywords || []),
        //        // ...(presentation.speakers || []),
        //     ].join(' || ');

        //     // Get results but exclude the current presentation
        //     const results = fuseForRelated.search(searchString)
        //         .filter(result => result.item.evtid !== presentation.evtid)
        //         .slice(0, maxResults);

        //     return results.map(result => ({
        //         presentation: result.item,
        //         score: result.score
        //     }));
        // }

        function findRelatedPresentations(presentation, allPresentations, maxResults = 5) {
            // Combine manual and AI tags
            const presentationTags = new Set([
                ...(presentation.tags || []),
                ...(presentation.aitags || []),
                ...(presentation.keywords || []),
                ...(presentation.speakers || [])

            ]);

            // Calculate similarity scores for all other presentations
            const scored = allPresentations
                .filter(p => p.evtid !== presentation.evtid) // Exclude current presentation
                .map(otherPresentation => {
                    const otherTags = new Set([
                        ...(otherPresentation.tags || []),
                        ...(otherPresentation.aitags || []),
                        ...(otherPresentation.keywords || []),
                        ...(otherPresentation.speakers || [])
                    ]);

                    // Calculate Jaccard similarity coefficient
                    const intersection = new Set([...presentationTags].filter(x => otherTags.has(x)));
                    const union = new Set([...presentationTags, ...otherTags]);
                    
                    const score = intersection.size / union.size;

                    // Add bonus for exact tag matches (especially for rare/specific tags)
                    const exactMatches = [...intersection].length;
                    const finalScore = score + (exactMatches * 0.2); // Boost score for each exact match

                    return {
                        presentation: otherPresentation,
                        score: Math.abs(finalScore),
                        matchingTags: [...intersection]
                    };
                })
                .filter(item => item.score > 0) // Only keep items with some similarity
                .sort((a, b) => b.score - a.score) // Sort by score descending
                .slice(0, maxResults);

            //scored.reverse();
            return scored;
        }


        function switchToPresentation(evtid) {
            // Kill the current search because this will interfere with togglePresentation
            const searchBar = document.querySelector('.search-bar');
            searchBar.value = "";
            // Trigger the search
            searchBar.dispatchEvent(new Event('input'));
            const index = presentations.findIndex(p => p.evtid === evtid);
            console.log("Switching to presentation", index);
            if (index !== -1) {
                const presentationElement = document.querySelector(`.presentation-item[data-index="${index}"]`);
                if (presentationElement) {
                        // Scroll the list to show the item
                        const listContainer = document.getElementById('presentationsList');
                        presentationElement.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'center' // Center the item in the viewport
                        });
                
                }
            

                togglePresentation(index);

                // const presentationElement = document.querySelector(`.presentation-content[data-index="${index}"]`);
                // console.log('1');
                // if (presentationElement) {
                //     console.log('2');
                //     togglePresentation(index);
                // }
            }
        }

        function getYouTubeEmbedUrl(url) {
            // Return early if url is undefined or null
            if (!url) {
                console.warn('No URL provided to getYouTubeEmbedUrl');
                return 'about:blank';
            }

            try {
                // Handle different YouTube URL formats
                let videoId;

                // Regular URL: https://www.youtube.com/watch?v=VIDEO_ID
                if (url.includes('watch?v=')) {
                    videoId = url.split('watch?v=')[1].split('&')[0];
                }
                // Short URL: https://youtu.be/VIDEO_ID
                else if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1].split('?')[0];
                }
                // Already an embed URL
                else if (url.includes('embed/')) {
                    return url;
                }
                // Just the ID
                else if (url.match(/^[a-zA-Z0-9_-]{11}$/)) {
                    videoId = url;
                }

                return videoId ? `https://www.youtube.com/embed/${videoId}` : 'about:blank';
            } catch (error) {
                console.error('Error processing YouTube URL:', error);
                return 'about:blank';
            }
        }

        function initializeResizing() {
            const tablePanel = document.querySelector('.table-panel');
            const dragHandle = document.getElementById('dragHandle');
            const mainContent = document.querySelector('.main-content');
            const overlay = document.getElementById('resizeOverlay');

            const container = document.querySelector('.main-content');
            const videoPanel = document.querySelector('.video-panel');
            let isResizing = false;
            let isResizingVertical = false;

            dragHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                overlay.style.display = 'block';
                overlay.classList.add('vertical');
                document.body.style.cursor = 'col-resize';

                function handleMouseMove(e) {
                    if (!isResizing) return;
                    const newWidth = e.clientX;
                    if (newWidth > 200 && newWidth < window.innerWidth - 400) {
                        tablePanel.style.width = newWidth + 'px';
                        mainContent.style.width = `calc(100% - ${newWidth}px - 6px)`;
                    }
                }

                function handleMouseUp() {
                    isResizing = false;
                    overlay.style.display = 'none';
                    overlay.classList.remove('vertical');
                    document.body.style.cursor = '';
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            const horizontalGutter = document.querySelector('.horizontal-gutter');
            horizontalGutter.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent text selection
                isResizingVertical = true;
                overlay.style.display = 'block';
                overlay.classList.add('horizontal');
                document.body.style.cursor = 'row-resize';

                function handleVerticalResize(e) {
                    if (!isResizingVertical) return;

                    // Get the container and its bounds
                    const containerRect = container.getBoundingClientRect();

                    // Calculate percentage based on mouse position
                    const percentage = ((e.clientY - containerRect.top) / containerRect.height) * 100;

                    if (percentage > 20 && percentage < 80) {
                        // Update the grid template rows with exact percentages
                        container.style.gridTemplateRows = `${percentage}% 6px calc(100% - ${percentage}% - 6px)`;

                        // Force a reflow to ensure changes are applied
                        container.style.display = 'grid';

                    }
                }

                function handleMouseUp() {
                    isResizingVertical = false;
                    overlay.style.display = 'none';
                    overlay.classList.remove('horizontal');
                    document.body.style.cursor = '';
                    document.removeEventListener('mousemove', handleVerticalResize);
                    document.removeEventListener('mouseup', handleMouseUp);
                }

                document.addEventListener('mousemove', handleVerticalResize);
                document.addEventListener('mouseup', handleMouseUp);
            });



        }

        function toggleSidebar() {
            const tablePanel = document.querySelector('.table-panel');
            tablePanel.classList.toggle('active');
        }


        // Add the search function:
        function searchForTag(tag) {
            const searchBar = document.querySelector('.search-bar');
            searchBar.value = tag;
            // Trigger the search
            searchBar.dispatchEvent(new Event('input'));
        }

        let currentDisplayedPresentations = presentations;

        function renderPresentations(items = presentations) {
            // Update our current displayed items
            currentDisplayedPresentations = items;

            const container = document.getElementById('presentationsList');
            container.innerHTML = items.map((presentation, displayIndex) => `
                <div class="presentation-item" data-index="${displayIndex}">
                    <div class="presentation-header" onclick="togglePresentation(${displayIndex})">
                        <div>
                            <div class="presentation-title">${presentation.title}</div>
                            <div class="presentation-speakers">${presentation.speakers.join(', ')}</div>
                        </div>
                    </div>
                    <div class="presentation-content"  onclick="togglePresentation(${displayIndex})">
                        <div class="presentation-abstract">${presentation.description ? presentation.description : presentation.abstract}</div>
                    </div>
                        <div class="tags">
                            ${presentation.tags.map(tag => `
                                <span class="tag" onclick="searchForTag('${tag}')">${tag}</span>
                            `).join('')}
                            ${presentation.aitags ? (presentation.aitags.filter(aitag => !presentation.tags.includes(aitag)).map(tag => `
                                <span class="tag" onclick="searchForTag('${tag}')">${tag}</span>
                            `).join('')) : ''}
                        </div>
                        </div>
            `).join('');
        }

        // This is quite messy, needs refactor
        // This sets up the Slides and Video tabs. The Slides tab is a big chunk of JavaScript. The Video tab is
        // a bit tricky; it is only displayed on mobile. On desktop the video tab is hidden because it's in a big 
        // split-screen frame.
        // Then it calls updateTextTabs to do the other tabs.
        function togglePresentation(displayIndex) {
            document.querySelectorAll('.presentation-item').forEach(item => {
                item.classList.remove('active');
            });

            const item = document.querySelector(`.presentation-item[data-index="${displayIndex}"]`);
            item.classList.add('active');

            // if (item) {
            //     const presentationItem = item.closest('.presentation-item');
            //     presentationItem.classList.add('active');
            // }

            // Get references to header elements for showing/hiding content
            //const header = content.previousElementSibling;

            // Only proceed with updating content if we're expanding (not collapsing)
            //if (item.classList.contains('active')) {
                // Get the presentation data from our current filtered/searched list
                const presentation = currentDisplayedPresentations[displayIndex];
                if (!presentation) {
                    console.error('Presentation not found for index:', displayIndex);
                    return;
                }

                // Get references to all the main content elements
                const videoPanel = document.querySelector('.video-panel');
                const slidesPanel = document.querySelector('.slides-panel');
                const horizontalGutter = document.querySelector('.horizontal-gutter');
                const mainContent = document.querySelector('.main-content');
                const videoTab = document.getElementById('video-tab');
                const videoTabButton = document.querySelector('.tab-button[data-tab="video"]');
                const slidesTabButton = document.querySelector('.tab-button[data-tab="slides"]');

                // Get references to the iframes themselves
                const videoIframe = videoPanel.querySelector('iframe');

                // First, reset everything to default state
                videoPanel.style.display = 'flex';
                slidesPanel.style.display = 'flex';
                horizontalGutter.style.display = 'block';
                mainContent.style.gridTemplateRows = '1fr 6px 1fr';  // Equal space for video and slides

                // This global is used for the Slides and Related tabs
                currentPresentation = currentDisplayedPresentations[displayIndex];


                // If we don't have any slides, hide the slides panel completely
                if (!presentation.slidesUrl && !presentation.slides) {
                    // hide slides button
                    slidesTabButton.style.display = 'none';
                    console.log("no slides");
                } else {
                    // Set up slides 
                    slidesTabButton.style.display = 'inline-block';
                    currentSlideIndex = 0;
                    updateSlidesTab(currentPresentation);
                }


                // Now handle different content combinations
                // This is all wrong right now. Ideally, display tabs on mobile, and open up the video 
                // display and sidebar if there is enough room (on desktop). On mobile, video should be a tab,
                // while on desktop that is unneeded. 
                if (isMobile()) {
                    // Mobile layout: only show video if available

                    if (presentation.videoUrl) {
                        const embedUrl = getYouTubeEmbedUrl(presentation.videoUrl);
                        const youtubeUrl = `${embedUrl}?autoplay=0&rel=0&modestbranding=1`;
                        if (!videoTab) { console.log("no video tab"); return; }
                        // Update video tab iframe
                        const videoTabIframe = videoTab.querySelector('iframe');
                        if (videoTabIframe) {
                            videoTabIframe.src = youtubeUrl;
                        }

                        // Show video tab button
                        videoTabButton.style.display = 'inline-block';
                        horizontalGutter.style.display = 'none';
                    } else {
                        // Hide video tab button if no video
                        videoTabButton.style.display = 'none';
                    }

                    // Disable main video panel
                    videoPanel.style.display = 'none';
                    console.log(presentation);

                } else {
                    // Desktop layout: handle all combinations
                    if (presentation.videoUrl && !presentation.slidesUrl) {
                        // Video only
                        slidesPanel.style.display = 'none';
                        //mainContent.style.gridTemplateRows = '1fr 0 0';  // All space to video

                        if (videoIframe) {
                            const embedUrl = getYouTubeEmbedUrl(presentation.videoUrl);
                            const youtubeUrl = `${embedUrl}?autoplay=0&rel=0&modestbranding=1`;
                            videoIframe.src = youtubeUrl;
                        }
                    }
                    else if (!presentation.videoUrl && presentation.slidesUrl) {
                        // This should be unreachable with current data, but handle it just in case
                    }
                    else if (presentation.videoUrl && presentation.slidesUrl) {
                        // Both video and slides
                        if (videoIframe) {
                            const embedUrl = getYouTubeEmbedUrl(presentation.videoUrl);
                            const youtubeUrl = `${embedUrl}?autoplay=0&rel=0&modestbranding=1`;
                            videoIframe.src = youtubeUrl;
                        }

                        // Grid stays at default 1fr 6px 1fr
                    }
                    else {
                        // Neither video nor slides
                        // This won't happen with current data, but handle it just in case
                    }
                }

                updateTextTabs(presentation);
            
        }

        function updateSlidesTab(presentation) {
            const slidesPanel = document.getElementById('slides-panel');

            if (!presentation.slidesUrl) {
                slidesPanel.innerHTML = `<div class="slides-browser">No slides available</div>`;
                return;
            }

            if (!presentation.slides) {
                // Show download button if only URL is available
                slidesPanel.innerHTML = `
                    <div class="slides-browser">
                        <div class="slides-download-button">
                            <a href="${presentation.slidesUrl}" target="_blank">
                                ðŸ“¥ Download Slides
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            // Show slides viewer if we have slide data
            const currentSlideIndex = 0;  // Start with first slide
            slidesPanel.innerHTML = `
                <div class="slides-browser">
                    <div class="slides-viewer">
                        <div class="current-slide">
                            <img src="${assetsBaseUrl}${presentation.slides[currentSlideIndex].image_path}" alt="Slide ${currentSlideIndex + 1}">
                            <div class="slide-nav-buttons">
                                <button class="slide-nav-button prev-slide" onclick="changeSlide(-1)">â†</button>
                                <button class="slide-nav-button next-slide" onclick="changeSlide(1)">â†’</button>
                            </div>
                        </div>
                        <div class="slides-thumbnails-wrapper">

                        <div class="slides-thumbnails">
                            ${presentation.slides.map((slide, index) => `
                                <div class="slide-thumbnail ${index === currentSlideIndex ? 'active' : ''}" 
                                    onclick="jumpToSlide(${index})">
                                    <img src="${assetsBaseUrl}${slide.thumbnail_path}" alt="Thumbnail ${index + 1}">
                                </div>
                            `).join('')}
                        </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTextTabs(presentation) {
            // Update Session tab
            const sessionContent = document.querySelector('.session-content');
            sessionContent.innerHTML = `
                <h1>${presentation.title}</h1>
                <div class="speakers">
                    ${presentation.speaker_details ?
                    presentation.speaker_details.map(speaker => `
                            <div class="speaker">
                                <div class="speaker-name">${speaker.name}</div>
                                <div class="speaker-role">${speaker.role}</div>
                            </div>
                        `).join('') :
                    `<div class="speaker">${presentation.speakers.join(', ')}</div>`
                }
                </div>
                <div class="abstract">${presentation.abstract}</div>
                <div class="links">
                    ${presentation.url ? `
                        <a href="https://kccncna2024.sched.com/${presentation.url}" 
                        class="link" target="_blank" rel="noopener noreferrer">
                        ðŸ“… View in Schedule
                        </a>
                    ` : ''}
                    ${presentation.videoUrl ? `
                        <a href="${presentation.videoUrl}" 
                        class="link" target="_blank" rel="noopener noreferrer">
                        ðŸŽ¥ Watch on YouTube
                        </a>
                    ` : ''}
                    ${presentation.slidesUrl ? `
                        <a href="${presentation.slidesUrl}" 
                        class="link" target="_blank" rel="noopener noreferrer">
                        ðŸ“‘ Download Slides
                        </a>
                    ` : ''}
                </div>
                `;

            // Handle Outline tab
            const outlineTab = document.querySelector('.outline-tab');
            const outlineContent = document.querySelector('.outline-content');
            if (presentation.outline) {
                outlineTab.style.display = 'block';
                outlineContent.innerHTML = `
                    <div class="ai-warning">
                        âš ï¸ This outline is AI-generated and may not be complete.
                    </div>
                    ${presentation.outline}
                `;
            } else {
                outlineTab.style.display = 'none';
            }

            // Handle Transcript tab
            const transcriptTab = document.querySelector('.transcript-tab');
            const transcriptContent = document.querySelector('.transcript-content');
            if (presentation.edited_transcript) {
                transcriptTab.style.display = 'block';
                // Extract body content from full HTML document
                const tempDiv = document.createElement('div');
                //tempDiv.innerHTML = presentation.edited_transcript;
                //const bodyContent = tempDiv.querySelector('body').innerHTML;

                transcriptContent.innerHTML = `
                    <div class="ai-warning">
                        âš ï¸ This transcript is AI-generated and may not be complete.
                    </div>
                    ${presentation.edited_transcript}
                `;
            } else {
                transcriptTab.style.display = 'none';
            }
            // Special case: If the Related tab is currently active, update it (not normally updated)
            const relatedTab = document.querySelector('.tab-button[data-tab="related"]');
            if (relatedTab.classList.contains('active')) {
                updateRelatedTab(presentation);
            }
        }

        function updateRelatedTab(presentation) {
            const relatedContent = document.querySelector('.related-content');
            relatedContent.innerHTML = '<div class="loading">Calculating related presentations...</div>';

            // Use setTimeout to allow the loading message to render
            setTimeout(() => {
                const related = findRelatedPresentations(presentation, presentations)
                // <div class="related-tags">                                    
                //                     ${presentation.tags.map(tag => 
                //                         `<span >${tag}</span>`
                //                     ).join(', ')}
                //                     ${presentation.aitags.map(tag => 
                //                         `<span >${tag}</span>`
                //                     ).join(', ')}
                //                     ${presentation.keywords.map(tag => 
                //                         `<span >${tag}</span>`
                //                     ).join(', ')}
                //                     </div>
                                // ${related.presentation.tags.map(tag => 
                //     `<span >${tag}</span>`
                // ).join(', ')}
                // ${related.presentation.aitags.map(tag => 
                //     `<span >${tag}</span>`
                // ).join(', ')}
                // ${related.presentation.keywords.map(tag => 
                //     `<span >${tag}</span>`
                // ).join(', ')}

                if (related && related.length > 0) {
                    relatedContent.innerHTML = `
                        <h2>Similar Presentations</h2>

                        ${related.map((related, index) => `
                            <div class="related-item" onclick="switchToPresentation('${related.presentation.evtid}')">
                                <div class="related-title">${related.presentation.title}</div>
                                <div class="related-speakers">${related.presentation.speakers.join(', ')}</div>
                                <div class="related-tags">

                                </div>
                                <div class="related-match">
                                    Match score: ${related.score.toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    relatedContent.innerHTML = '<p>No related presentations found.</p>';
                }
            }, 0);
        }

        function initializeSearch(presentations) {
            fuse = new Fuse(presentations, {
                keys: [
                    { name: 'title', weight: 2 },     // Most important
                    { name: 'speakers', weight: 2 },
                    { name: 'tags', weight: 1 },
                    { name: 'abstract', weight: 1.5 },
                    { name: 'keywords', weight: 1.5 },
                    { name: 'description', weight: 1.5 },
                    { name: 'aitags', weight: 1.5 }
                ],
                threshold: 0.3,
                distance: 100,         // How far to look for matches
                minMatchCharLength: 2, // Minimum characters to match
                shouldSort: true,      // Sort by relevance
                findAllMatches: true,
                includeScore: true     // Include match scores
            });
            // Separate index just on tags and speaker names for the Related tab
            // fuseForRelated = new Fuse(presentations, {
            //     keys: [
            //         { name: 'tags', weight: 1 },    
            //         { name: 'aitags', weight: 1 },    
            //         //{ name: 'keywords', weight: 1 },  
            //         //{ name: 'speakers', weight: 1 },  

            //     ],
            //     shouldSort:true,
            //     findAllMatches: true,
            //     includeScore: true,
            //     threshold: 1.0  // Allow somewhat loose matching
            // });
        }

        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const panels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and panels
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    panels.forEach(panel => panel.classList.remove('active'));

                    // Add active class to clicked button and corresponding panel
                    button.classList.add('active');
                    const tabId = `${button.dataset.tab}-tab`;
                    const panel = document.getElementById(tabId);
                    if (panel) {
                        panel.classList.add('active');
                        // Unlike the other tabs, this is a very expensive computation so we only bother when it's clicked
                        if (tabId === 'related-tab' && currentPresentation) {
                            updateRelatedTab(currentPresentation);
                        }
                    }
                    
                });
            });
        }

        document.querySelector('.search-bar').addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();

            if (!searchTerm) {
                renderPresentations(presentations);
                return;
            }

            const searchResults = fuse.search(searchTerm);

            // Only show results with good match scores
            const goodMatches = searchResults
                .filter(result => result.score < 0.5)  // Lower score = better match
                .map(result => result.item);

            if (goodMatches.length === 0) {
                // Show "no results" message
                document.getElementById('presentationsList').innerHTML = `
            <div class="no-results">
                No presentations found matching "${searchTerm}"
            </div>
        `;
            } else {
                renderPresentations(goodMatches);
            }
        });

        let currentPresentation = null;
        let currentSlideIndex = 0;

        function changeSlide(delta) {
            if (!currentPresentation?.slides) return;

            const newIndex = currentSlideIndex + delta;
            if (newIndex >= 0 && newIndex < currentPresentation.slides.length) {
                jumpToSlide(newIndex);
            }
        }

        function jumpToSlide(index) {
            if (!currentPresentation?.slides) return;

            currentSlideIndex = index;
            const currentSlide = document.querySelector('.current-slide img');
            const thumbnails = document.querySelectorAll('.slide-thumbnail');

            if (currentSlide) {
                currentSlide.src = `${assetsBaseUrl}${currentPresentation.slides[index].image_path}`;
            }

            thumbnails.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }


        // If the window is resized, hide or show the video panel as needed.
        window.addEventListener('resize', () => {

            const isMobileB = isMobile();
            const videoTabButton = document.querySelector('.tab-button[data-tab="video"]');
            const videoPanel = document.querySelector('.video-panel');

            if (!isMobileB) {
                videoTabButton.style.display = 'none';
                // Switch to session tab if we're currently on video tab
                if (videoTabButton.classList.contains('active')) {
                    document.querySelector('.tab-button[data-tab="session"]').click();
                }
            }
        });


        renderPresentations();
        initializeResizing();
        initializeTabs();
    </script>
</body>

</html>